# OnlyNotes: Supabase Backend & Schema SRS

## 1. Project Scope
We are building the backend for **OnlyNotes**, a social note-sharing app.
**Core Logic:** Users (Students) belong to a **University** and **Program**. They upload **Notes** linked to specific **Courses**. The "Addiction Loop" involves swiping on notes (Home Feed) and unlocking them via scrolling (Reading Mode).

## 2. Database Schema (PostgreSQL)

### A. Academic Hierarchy (The Context)
*These tables structure the content so students see relevant notes.*

1.  **`universities`**
    * `id` (uuid, PK)
    * `name` (text, unique) - e.g., "University of Toronto"
    * `domain` (text) - e.g., "@utoronto.ca" (for auto-joining)
    * `created_at` (timestamptz)

2.  **`programs`**
    * `id` (uuid, PK)
    * `university_id` (uuid, FK -> universities.id)
    * `name` (text) - e.g., "Computer Science", "Mechanical Engineering"

3.  **`courses`**
    * `id` (uuid, PK)
    * `university_id` (uuid, FK -> universities.id)
    * `code` (text) - e.g., "CS101", "MAT200"
    * `name` (text) - e.g., "Intro to Java"

### B. Users & Content
1.  **`profiles`** (Extends `auth.users`)
    * `id` (uuid, PK, references auth.users)
    * `username` (text, unique)
    * `avatar_url` (text)
    * `university_id` (uuid, FK -> universities.id)
    * `program_id` (uuid, FK -> programs.id)
    * `enrollment_year` (int)
    * `total_score` (int, default 0) - *Gamification points*

2.  **`notes`**
    * `id` (uuid, PK)
    * `author_id` (uuid, FK -> profiles.id)
    * `course_id` (uuid, FK -> courses.id)
    * `title` (text)
    * `hook_summary` (text) - *Visible on card (max 280 chars)*
    * `full_content` (text) - *Hidden behind blur*
    * `media_url` (text) - *Optional image/diagram URL*
    * `created_at` (timestamptz)

### C. The "Moat" (Engagement Logic)
1.  **`swipes`** (The Filter)
    * `id` (uuid, PK)
    * `user_id` (uuid, FK -> profiles.id)
    * `note_id` (uuid, FK -> notes.id)
    * `action` (enum: 'LEFT', 'RIGHT') - *Left=Skip, Right=Save*
    * `created_at` (timestamptz)
    * *Constraint:* Unique composite key on `(user_id, note_id)` to prevent double swiping.

2.  **`unlocks`** (The Upvote)
    * `id` (uuid, PK)
    * `user_id` (uuid, FK -> profiles.id)
    * `note_id` (uuid, FK -> notes.id)
    * `triggered_at` (timestamptz)
    * *Logic:* Inserted when user scrolls past blur. This counts as the "Upvote" for leaderboards.

---

## 3. Row Level Security (RLS) Policies

* **Universities/Programs/Courses:**
    * `Enable Read Access`: public (true)
    * `Enable Insert`: Authenticated users (allow students to add missing courses).

* **Profiles:**
    * `Read`: Public.
    * `Update`: Users can only update their own profile (`auth.uid() == id`).

* **Notes:**
    * `Read`: Public.
    * `Insert`: Authenticated users.
    * `Update`: Authors only.

* **Swipes & Unlocks:**
    * `Read`: Users can see their own interaction history.
    * `Insert`: Authenticated users.

---

## 4. Supabase Edge Functions (Optional but Recommended)

**Function: `calculate_leaderboard`**
* **Trigger:** Scheduled (Cron) every 24 hours OR triggered via database webhook on `unlocks` insert.
* **Logic:**
    1.  Sum `unlocks` count for each `author_id`.
    2.  Update `profiles.total_score`.
    3.  Rank users within their specific `university_id`.

---

## 5. Seed Data Prompt (For AI Generation)
*Use this prompt to get your AI to fill the database with dummy data for testing.*

> "Generate a Supabase SQL seed script.
> 1. Create 1 University: 'Tech University'.
> 2. Create 2 Programs: 'Computer Science', 'Business'.
> 3. Create 4 Courses: 'CS101 (Algorithms)', 'CS102 (Databases)', 'BUS101 (Marketing)', 'BUS200 (Finance)'.
> 4. Create 5 Dummy Users linked to these programs.
> 5. Create 20 Notes distributed among these courses. Make the `hook_summary` catchy and educational.
> 6. Ensure `hook_summary` is under 150 characters."